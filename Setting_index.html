const SPREADSHEET_ID = '1WFhMCO1-WFPyHzWcmoA-D3DrHOwIGp2CNSOjBfpu-44';
const SHEET_DATETIME = 'ตั้งค่าทั่วไป'; // ชื่อแผ่นข้อมูล

// ฟังก์ชันที่ทำงานเมื่อรับคำร้องขอ GET
function doGet(e) {
  if (e.parameter && e.parameter.page) {
    if (e.parameter.page === 'settings') {
      return HtmlService.createHtmlOutputFromFile('settings')
        .setTitle('ตั้งค่าการนัดหมาย')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    } else {
      return HtmlService.createHtmlOutputFromFile('index.html')
        .setTitle('ระบบบันทึกการนัดหมาย')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    }
  } else {
    return HtmlService.createHtmlOutputFromFile('index.html')
      .setTitle('ระบบบันทึกการนัดหมาย')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}

// ฟังก์ชันดึงข้อมูลจาก SHEET_DATETIME
function getSettings() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_DATETIME);
  const data = sheet.getDataRange().getDisplayValues(); // ใช้ getDisplayValues() เพื่อดึงเป็นข้อความ
  const headers = data[0];
  const rows = data.slice(1);

  const settings = rows.map(row => {
    return {
      timeSlot: row[0].toString(), // จัดเก็บเป็นข้อความ
      slots: row[1],
      holiday: row[2],
      service: row[3],
      branch: row[4],
      key: row[5]
    };
  });

  return settings;
}

// ฟังก์ชันเพิ่มข้อมูลใหม่
function addSetting(newSetting) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_DATETIME);
  const lastRow = sheet.getLastRow();
  const newKey = lastRow + 1; // ใช้หมายเลขแถวถัดไปเป็น key, แถวแรกเป็นหัวข้อ

  sheet.appendRow([
    newSetting.timeSlot,             // timeSlot เป็นข้อความ
    parseInt(newSetting.slots, 10),
    newSetting.holiday || '',
    newSetting.service,
    newSetting.branch,
    newKey                           // เพิ่ม key เป็นคอลัมน์สุดท้าย
  ]);
  return 'เพิ่มข้อมูลสำเร็จ!';
}

// ฟังก์ชันอัพเดทข้อมูลทั้งหมด
function updateAllSettings(updates) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_DATETIME);
  const data = sheet.getDataRange().getValues();

  updates.forEach(setting => {
    const { key, timeSlot, slots, holiday, service, branch } = setting;
    const rowIndex = data.findIndex(row => row[5].toString() === key.toString());
    if (rowIndex < 0) {
      throw new Error(`ไม่พบข้อมูลที่ต้องการแก้ไข: ${key}`);
    }
    const rowNumber = rowIndex + 1; // เนื่องจาก getRange เริ่มต้นที่ 1

    // ตรวจสอบความถูกต้องของข้อมูล
    if (isNaN(slots) || parseInt(slots, 10) < 1) {
      throw new Error(`สลอตต้องเป็นตัวเลขและมากกว่า 0 สำหรับ Key: ${key}`);
    }

    // อัพเดทข้อมูลในชีต
    sheet.getRange(rowNumber, 1).setValue(timeSlot); // จัดเก็บเป็นข้อความ
    sheet.getRange(rowNumber, 2).setValue(parseInt(slots, 10));
    sheet.getRange(rowNumber, 3).setValue(holiday !== '-' ? holiday : '');
    sheet.getRange(rowNumber, 4).setValue(service);
    sheet.getRange(rowNumber, 5).setValue(branch);
    // คอลัมน์ที่ 6 คือ key ซึ่งไม่ต้องแก้ไข
  });

  return 'อัพเดทข้อมูลทั้งหมดสำเร็จ!';
}

// ฟังก์ชันลบข้อมูล
function deleteSetting(idKey) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_DATETIME);
  const data = sheet.getDataRange().getValues();
  const rowIndex = data.findIndex(row => row[5].toString() === idKey.toString());
  if (rowIndex < 0) {
    throw new Error('ไม่พบข้อมูลที่ต้องการลบ.');
  }
  const rowNumber = rowIndex + 1; // เนื่องจาก getRange เริ่มต้นที่ 1
  sheet.deleteRow(rowNumber);
  return 'ลบข้อมูลสำเร็จ!';
}
